<script lang="ts">
  import {onMount} from "svelte"
  import {ctx, last, type Emitter} from "@welshman/lib"
  import {now} from "@welshman/signer"
  import {
    createEvent,
    toNostrURI,
    DVM_REQUEST_PUBLISH_SCHEDULE,
    type TrustedEvent,
  } from "@welshman/util"
  import {
    session,
    tagPubkey,
    signer,
    type ThunkStatusByUrl,
    type ThunkStatus,
    type Thunk,
  } from "@welshman/app"
  import {PublishStatus} from "@welshman/net"
  import {DVMEvent} from "@welshman/dvm"
  import {writable} from "svelte/store"
  import {nip19} from "nostr-tools"
  import Anchor from "src/partials/Anchor.svelte"
  import Content from "src/partials/Content.svelte"
  import Field from "src/partials/Field.svelte"
  import FlexColumn from "src/partials/FlexColumn.svelte"
  import {showInfo, showPublishInfo, showToast, showWarning} from "src/partials/Toast.svelte"
  import Compose from "src/app/shared/Compose.svelte"
  import NsecWarning from "src/app/shared/NsecWarning.svelte"
  import NoteContent from "src/app/shared/NoteContent.svelte"
  import NoteOptions from "src/app/shared/NoteOptions.svelte"
  import {getEditor} from "src/app/editor"
  import {drafts} from "src/app/state"
  import {router} from "src/app/util/router"
  import {env, getClientTags, makeDvmRequest, publish, sign, userSettings} from "src/engine"
  import {warn} from "src/util/logger"
  import {commaFormat} from "src/util/misc"

  export let quote = null
  export let pubkey = null

  const uploading = writable(false)
  const wordCount = writable(0)
  const charCount = writable(0)

  let showPreview = false
  let showOptions = false
  let publishing = false

  let editor: ReturnType<typeof getEditor>
  let element: HTMLElement
  let options = {warning: "", anonymous: false, publish_at: null}

  const SHIPYARD_PUBKEY = "85c20d3760ef4e1976071a569fb363f4ff086ca907669fb95167cdc5305934d1"
  const nsecWarning = writable(null)

  const openOptions = () => {
    showOptions = true
  }

  const closeOptions = () => {
    showOptions = false
  }

  const setOptions = values => {
    options = {...options, ...values}
    showOptions = false
  }

  const bypassNsecWarning = () => {
    nsecWarning.set(null)
    onSubmit({skipNsecWarning: true})
  }

  const onSubmit = async ({skipNsecWarning = false} = {}) => {
    // prevent sending before media are uploaded
    if ($uploading || publishing) return

    publishing = true

    const content = $editor.getText({blockSeparator: "\n"}).trim()

    if (!content) return showWarning("Please provide a description.")

    if (!skipNsecWarning && content.match(/\bnsec1.+/)) return nsecWarning.set(true)

    const tags = [...$editor.storage.nostr.getEditorTags(), ...getClientTags()]

    if (options.warning) {
      tags.push(["content-warning", options.warning])
    }

    if (quote) {
      tags.push(tagPubkey(quote.pubkey))
    }

    const template = createEvent(1, {
      content,
      tags,
      created_at:
        (options.publish_at && Math.floor(options.publish_at.getTime() / 1000)) || undefined,
    })

    const event = await sign(template, options)

    drafts.set("notecreate", $editor.getHTML())

    let thunk: Thunk, emitter: Emitter

    // if a delay is set, send the event through the DVM
    router.clearModals()

    if (options.publish_at) {
      // take the first DVM Handler found

      const dvmContent = await $signer.nip04.encrypt(
        SHIPYARD_PUBKEY,
        JSON.stringify([
          ["i", JSON.stringify(event), "text"],
          ["param", "relays", ...ctx.app.router.FromUser().getUrls()],
        ]),
      )
      const dvmEvent = await sign(
        createEvent(DVM_REQUEST_PUBLISH_SCHEDULE, {
          content: dvmContent,
          tags: [["p", SHIPYARD_PUBKEY], ["encrypted"]],
        }),
      )

      const dvmRequest = makeDvmRequest({
        event: dvmEvent,
        relays: env.DVM_RELAYS,
        reportProgress: true,
        delay: $userSettings.send_delay,
      })

      thunk = dvmRequest.thunk
      emitter = dvmRequest.emitter
    } else {
      router.clearModals()

      thunk = publish({
        event,
        relays: ctx.app.router.PublishEvent(event).getUrls(),
        delay: $userSettings.send_delay,
      })
    }

    thunk.result.finally(() => {
      charCount.set(0)
      wordCount.set(0)
      drafts.delete("notecreate")
    })

    if ($userSettings.send_delay > 0) {
      showToast({
        id: "send-delay",
        type: "delay",
        timeout: $userSettings.send_delay / 1000,
        onCancel: () => {
          thunk.controller.abort()
          router.at("notes/create").open()
        },
      })
    }

    thunk.status.subscribe((status: ThunkStatusByUrl) => {
      if (
        Object.values(status).length === thunk.request.relays.length &&
        Object.values(status).every((s: ThunkStatus) => s.status === PublishStatus.Pending)
      ) {
        showPublishInfo(thunk)
      }
    })

    if (emitter) {
      emitter.on(DVMEvent.Progress, (url: string, event: TrustedEvent) => {
        $signer.nip04.decrypt(SHIPYARD_PUBKEY, event.content).then(data => {
          try {
            data = JSON.parse(data)[0]
            showInfo(data[2] || "Your note is " + data[1] + "!")
          } catch (e) {
            warn(e)
          }
        })
      })
    }

    publishing = false
  }

  const togglePreview = () => {
    showPreview = !showPreview
  }

  const pubkeyEncoder = {
    encode: pubkey => {
      const relays = ctx.app.router.FromPubkeys([pubkey]).getUrls()
      const nprofile = nip19.nprofileEncode({pubkey, relays})

      return toNostrURI(nprofile)
    },
    decode: link => {
      // @ts-ignore
      return nip19.decode(last(link.split(":"))).data.pubkey
    },
  }

  onMount(() => {
    editor = getEditor({
      element,
      uploading,
      content: drafts.get("notecreate") || "",
      submit: onSubmit,
      autofocus: true,
      charCount,
      wordCount,
    })

    if (pubkey && pubkey !== $session.pubkey) {
      $editor.commands.insertNProfile({nprofile: pubkeyEncoder.encode(pubkey)})
    }

    if (quote) {
      const nevent = nip19.neventEncode({
        id: quote.id,
        kind: quote.kind,
        author: quote.pubkey,
        relays: ctx.app.router.Event(quote).getUrls(),
      })

      $editor.commands.insertNEvent({nevent: toNostrURI(nevent)})
    }
  })
</script>

<form on:submit|preventDefault={() => onSubmit()}>
  <Content size="lg">
    <div class="flex gap-2">
      <span class="text-2xl font-bold">Create a Note</span>
    </div>
    <FlexColumn>
      <Field label="What do you want to say?">
        <div
          class="rounded-xl border border-solid border-neutral-600 p-3"
          class:bg-white={!showPreview}
          class:text-black={!showPreview}
          class:bg-tinted-700={showPreview}>
          {#if showPreview}
            <NoteContent
              note={{content: $editor.getText({blockSeparator: "\n"}).trim(), tags: []}} />
          {/if}
          <div class:hidden={showPreview}>
            <Compose bind:element editor={$editor} class="min-h-24" />
          </div>
        </div>
        <div class="flex items-center justify-end gap-2 text-neutral-200">
          <small>
            {commaFormat($charCount)} characters
          </small>
          <span>•</span>
          <small>
            {commaFormat($wordCount)} words
          </small>
          <span>•</span>
          <button type="button" on:click={togglePreview} class="cursor-pointer text-sm underline">
            {showPreview ? "Hide" : "Show"} Preview
          </button>
          <button type="button" on:click={openOptions} class="cursor-pointer text-sm">
            <i class="fa fa-cog" />
          </button>
        </div>
      </Field>
      <div class="flex gap-2">
        <Anchor
          button
          tag="button"
          type="submit"
          class="flex-grow"
          disabled={$uploading || publishing}>
          {#if $uploading || publishing}
            <i class="fa fa-circle-notch fa-spin" />
          {:else if options?.publish_at && Math.floor(options?.publish_at / 1000) > now()}
            Schedule
          {:else}
            Send
          {/if}
        </Anchor>
        <button
          class="hover:bg-white-l staatliches flex h-7 w-7 cursor-pointer items-center justify-center gap-2 whitespace-nowrap rounded bg-white px-6 text-xl text-black transition-all"
          on:click|preventDefault={() => $editor.chain().selectFiles().run()}>
          <i class="fa fa-upload" />
        </button>
      </div>
    </FlexColumn>
  </Content>
</form>

{#if showOptions}
  <NoteOptions onClose={closeOptions} onSubmit={setOptions} initialValues={options} publishAt />
{/if}

{#if $nsecWarning}
  <NsecWarning onAbort={() => nsecWarning.set(null)} onBypass={bypassNsecWarning} />
{/if}
